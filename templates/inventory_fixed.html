{% extends "base.html" %}

{% block title %}Inventory - Healthcare Inventory Management{% endblock %}

{% block extra_head %}
<style>
.inventory-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.inventory-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    padding: 15px 20px;
}

.card-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.expand-icon {
    transition: transform 0.3s ease;
    color: #6c757d;
}

.expand-icon.expanded {
    transform: rotate(90deg);
    color: #007bff;
}

.item-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1em;
}

.item-type {
    color: #6c757d;
    font-size: 0.9em;
    margin-left: 8px;
}

.quantity-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.quantity-badge {
    background: #28a745;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9em;
}

.quantity-badge.low-stock {
    background: #dc3545;
}

.quantity-badge.medium-stock {
    background: #ffc107;
    color: #000;
}

.minimum-stock-info {
    color: #6c757d;
    font-size: 0.85em;
}

.card-body {
    display: none;
    padding: 20px;
    background: #fafafa;
}

.card-body.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.details-table {
    background: white;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.details-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 8px;
}

.details-table td {
    padding: 10px 8px;
    vertical-align: middle;
    border-bottom: 1px solid #f0f0f0;
}

.expiry-status {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
}

.expiry-status.expired {
    background: #dc3545;
    color: white;
}

.expiry-status.expires-soon {
    background: #ffc107;
    color: #000;
}

.expiry-status.good {
    background: #28a745;
    color: white;
}

.expiry-status.no-expiry {
    background: #6c757d;
    color: white;
}

.action-buttons {
    display: flex;
    gap: 5px;
}

.search-container {
    position: relative;
    max-width: 400px;
}

.search-input {
    padding-right: 40px;
}

.search-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    font-size: 16px;
}

.search-clear:hover {
    color: #dc3545;
}

.inventory-summary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
}

.summary-item {
    text-align: center;
}

.summary-number {
    font-size: 2em;
    font-weight: 700;
    margin-bottom: 5px;
}

.summary-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.low-stock-alert {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.no-items-message {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.no-items-message i {
    font-size: 4em;
    margin-bottom: 20px;
    opacity: 0.3;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-boxes me-2"></i>
            Inventory Overview
        </h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('add_items') }}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i>
                Add Items
            </a>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="inventory-summary">
        <div class="row">
            <div class="col-md-3 summary-item">
                <div class="summary-number">{{ unique_items|length }}</div>
                <div class="summary-label">Unique Items</div>
            </div>
            <div class="col-md-3 summary-item">
                <div class="summary-number">{{ total_items }}</div>
                <div class="summary-label">Total Quantity</div>
            </div>
            <div class="col-md-3 summary-item">
                <div class="summary-number">{{ low_stock_count }}</div>
                <div class="summary-label">Low Stock Items</div>
            </div>
            <div class="col-md-3 summary-item">
                <div class="summary-number">{{ expiring_soon_count }}</div>
                <div class="summary-label">Expiring Soon</div>
            </div>
        </div>
    </div>

    <!-- Low Stock Alert -->
    {% if low_stock_items %}
    <div class="low-stock-alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>{{ low_stock_items|length }} item(s) are running low on stock:</strong>
        {% for item in low_stock_items[:3] %}
            {{ item.name }}{% if not loop.last %}, {% endif %}
        {% endfor %}
        {% if low_stock_items|length > 3 %}
            and {{ low_stock_items|length - 3 }} more...
        {% endif %}
    </div>
    {% endif %}

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="search-container">
                <input type="text" 
                       class="form-control search-input" 
                       id="searchInput" 
                       placeholder="Search items by name or type..."
                       autocomplete="off">
                <button type="button" class="search-clear" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="col-md-6">
            <div class="d-flex justify-content-end align-items-center">
                <span class="text-muted me-3" id="inventoryCount">
                    Items ({{ unique_items|length }} found)
                </span>
            </div>
        </div>
    </div>

    <!-- Inventory Items -->
    <div id="inventoryContainer">
        {% if unique_items %}
            {% for item_name, item_data in unique_items.items() %}
                {% set item_type = item_data.type %}
                {% set grouped_items = item_data.grouped_items %}
                {% set total_quantity = item_data.total_quantity %}
                {% set minimum_stock = item_data.minimum_stock %}
                {% set is_low_stock = item_data.is_low_stock %}
                
                <div class="inventory-card" 
                     data-item-name="{{ item_name.lower() }}" 
                     data-item-type="{{ item_type.lower() }}">
                    
                    <!-- Card Header -->
                    <div class="card-header" onclick="toggleItemDetails({{ loop.index }})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chevron-right expand-icon me-3" id="icon-{{ loop.index }}"></i>
                                <div>
                                    <div class="item-name">{{ item_name }}</div>
                                    <span class="item-type">{{ item_type }}</span>
                                </div>
                            </div>
                            
                            <div class="quantity-info">
                                <div class="quantity-badge {% if is_low_stock %}low-stock{% elif total_quantity < minimum_stock * 2 %}medium-stock{% endif %}">
                                    {{ total_quantity }} units
                                </div>
                                <div class="minimum-stock-info">
                                    Min: {{ minimum_stock }}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="event.stopPropagation(); editMinimumStock('{{ item_name }}', '{{ item_type }}', {{ minimum_stock }})"
                                            title="Edit minimum stock">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" 
                                            onclick="event.stopPropagation(); showItemTransferModal('{{ item_name }}', '{{ item_type }}', {{ total_quantity }})"
                                            title="Transfer items">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="event.stopPropagation(); showItemUsageModal('{{ item_name }}', '{{ item_type }}', {{ total_quantity }})"
                                            title="Record usage">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <a href="{{ url_for('item_history', name=item_name, type=item_type) }}" 
                                       class="btn btn-outline-info btn-sm" 
                                       onclick="event.stopPropagation();"
                                       title="View history">
                                        <i class="fas fa-history"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Body (Details) -->
                    <div class="card-body" id="details-{{ loop.index }}">
                        <h6 class="mb-3">
                            <i class="fas fa-boxes me-2"></i>
                            Individual Items for {{ item_name }}
                        </h6>
                        <div class="table-responsive">
                            <table class="details-table table table-sm">
                                <thead>
                                    <tr>
                                        <th>Brand</th>
                                        <th>Size</th>
                                        <th>Quantity</th>
                                        <th>Storage</th>
                                        <th>Expiry Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group in grouped_items %}
                                        <tr>
                                            <td>{{ group['brand'] or '-' }}</td>
                                            <td>{{ group['size'] or '-' }}</td>
                                            <td>
                                                <strong>{{ group['quantity'] }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if group['location'] == 'cabinet' else 'secondary' }}">
                                                    {{ group['location'].title() }}
                                                </span>
                                            </td>
                                            <td>{{ group['expiry_date'] or '-' }}</td>
                                            <td>
                                                {% if group['expiry_status'] %}
                                                    <span class="expiry-status {{ group['expiry_status'] }}">
                                                        {% if group['expiry_status'] == 'expired' %}Expired
                                                        {% elif group['expiry_status'] == 'expires-soon' %}Expires Soon
                                                        {% elif group['expiry_status'] == 'good' %}Good
                                                        {% else %}No Expiry
                                                        {% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="expiry-status no-expiry">No Expiry</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    {% if group['items'] %}
                                                        {% for item in group['items'] %}
                                                            <a href="{{ url_for('individual_item_history', item_id=item.id) }}" 
                                                               class="btn btn-outline-info btn-xs me-1" 
                                                               title="View item #{{ item.id }} history">
                                                                #{{ item.id }}
                                                            </a>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-items-message">
                <i class="fas fa-box-open"></i>
                <h4>No items found</h4>
                <p>Your inventory is empty. Start by <a href="{{ url_for('add_items') }}">adding some items</a>.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Toggle item details
function toggleItemDetails(itemIndex) {
    const detailsDiv = document.getElementById(`details-${itemIndex}`);
    const icon = document.getElementById(`icon-${itemIndex}`);
    
    if (detailsDiv.classList.contains('show')) {
        detailsDiv.classList.remove('show');
        icon.classList.remove('expanded');
    } else {
        // Close all other expanded items first
        document.querySelectorAll('.card-body.show').forEach(div => {
            div.classList.remove('show');
        });
        document.querySelectorAll('.expand-icon.expanded').forEach(expandIcon => {
            expandIcon.classList.remove('expanded');
        });
        
        // Open the clicked item
        detailsDiv.classList.add('show');
        icon.classList.add('expanded');
    }
}

// Search functionality
function searchInventory() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput.value.toLowerCase().trim();
    filterInventoryCards(query);
}

function filterInventoryCards(query) {
    const cards = document.querySelectorAll('.inventory-card');
    const lowerQuery = query.toLowerCase().trim();
    let visibleCount = 0;
    
    cards.forEach(card => {
        const itemName = card.dataset.itemName;
        const itemType = card.dataset.itemType;
        
        const matches = !lowerQuery || 
                       itemName.includes(lowerQuery) || 
                       itemType.includes(lowerQuery);
        
        if (matches) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
            // Close expanded details when hiding
            const cardBody = card.querySelector('.card-body');
            if (cardBody) {
                cardBody.classList.remove('show');
            }
            const icon = card.querySelector('.expand-icon');
            if (icon) {
                icon.classList.remove('expanded');
            }
        }
    });
    
    // Update results count
    const countElement = document.getElementById('inventoryCount');
    if (countElement) {
        if (lowerQuery) {
            countElement.textContent = `Items (${visibleCount} found, filtered)`;
        } else {
            countElement.textContent = `Items (${visibleCount} found)`;
        }
    }
}

// Clear search
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        filterInventoryCards('');
    }
}

// Auto-search as user types
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', searchInventory);
    }
});

// Show transfer modal for entire item
function showItemTransferModal(itemName, itemType, totalQuantity) {
    window.location.href = `/transfer?item=${encodeURIComponent(itemName)}`;
}

// Edit minimum stock for an item
function editMinimumStock(itemName, itemType, currentStock) {
    const newStock = prompt(`Enter new minimum stock level for ${itemName}:`, currentStock);
    if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
        fetch(`/api/update-minimum-stock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: itemName,
                type: itemType,
                minimum_stock: parseInt(newStock)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating minimum stock: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating minimum stock');
        });
    }
}

// Show usage modal for entire item
function showItemUsageModal(itemName, itemType, totalQuantity) {
    window.location.href = `/usage?item=${encodeURIComponent(itemName)}`;
}
</script>
{% endblock %}