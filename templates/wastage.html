{% extends "base.html" %}

{% block title %}Wastage Tracking - Healthcare Inventory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-trash-alt me-2"></i>
            Wastage Tracking
        </h1>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ expired_items|length }}</h4>
                        <p class="card-text">Items Ready for Disposal</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ wastage_history|length }}</h4>
                        <p class="card-text">Recent Wastage Records</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ wastage_history|map(attribute='quantity')|sum or 0 }}</h4>
                        <p class="card-text">Total Units Wasted</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Expired Items for Disposal -->
{% if expired_items %}
<div class="card mb-4">
    <div class="card-header bg-danger">
        <h5 class="card-title mb-0">
            <i class="fas fa-times-circle me-2"></i>
            Expired Items Ready for Disposal ({{ expired_items|length }})
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-danger">
            <strong><i class="fas fa-exclamation-triangle me-2"></i>Action Required!</strong>
            These items have expired and should be disposed of according to your facility's protocols.
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped" id="expiredTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Bag</th>
                        <th>Expired Date</th>
                        <th>Days Overdue</th>
                        <th>Batch</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in expired_items %}
                    <tr>
                        <td><strong>{{ item.name }}</strong></td>
                        <td>
                            <span class="badge bg-secondary">{{ item.type }}</span>
                        </td>
                        <td>{{ item.size or '-' }}</td>
                        <td>
                            <span class="badge bg-danger">{{ item.quantity }}</span>
                        </td>
                        <td>{{ item.bag.name }}</td>
                        <td>
                            <strong class="text-danger">{{ item.expiry_date.strftime('%m/%d/%Y') }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-danger">
                                {{ (today - item.expiry_date).days }} days
                            </span>
                        </td>
                        <td>{{ item.batch_number or '-' }}</td>
                        <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="showWastageModal('{{ item.id }}', '{{ item.name }}', {{ item.quantity }}, '{{ item.type }}', '{{ item.bag.name }}')">
                                <i class="fas fa-trash"></i> Record Wastage
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Wastage History -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-history me-2"></i>
            Recent Wastage Records
        </h5>
    </div>
    <div class="card-body">
        {% if wastage_history %}
        <div class="table-responsive">
            <table class="table table-striped" id="wastageTable">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>From Bag</th>
                        <th>Expiry Date</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in wastage_history %}
                    <tr>
                        <td>
                            <div>
                                <strong>{{ record.timestamp.strftime('%m/%d/%Y') }}</strong><br>
                                <small class="text-muted">{{ record.timestamp.strftime('%H:%M:%S') }}</small>
                            </div>
                        </td>
                        <td><strong>{{ record.item_name }}</strong></td>
                        <td>
                            <span class="badge bg-secondary">{{ record.item_type }}</span>
                        </td>
                        <td>
                            <span class="badge bg-danger">{{ record.quantity }}</span>
                        </td>
                        <td>{{ record.from_bag }}</td>
                        <td>
                            {% if record.expiry_date %}
                                {{ record.expiry_date.strftime('%m/%d/%Y') }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.notes %}
                                <small>{{ record.notes }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-3">
            <a href="{{ url_for('history') }}?type_filter=wastage" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>View All Wastage History
            </a>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-clipboard fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No Wastage Records Yet</h6>
            <p class="text-muted">Wastage records will appear here when items are disposed of.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- No Expired Items -->
{% if not expired_items %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
        <h4 class="text-success">No Expired Items!</h4>
        <p class="text-muted">All items in your inventory are within their expiry dates.</p>
        <a href="{{ url_for('expiry') }}" class="btn btn-primary">
            <i class="fas fa-calendar-check me-2"></i>View Expiry Monitor
        </a>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="btn-group flex-wrap" role="group">
                    <a href="{{ url_for('expiry') }}" class="btn btn-outline-warning">
                        <i class="fas fa-clock me-1"></i>Expiry Monitor
                    </a>
                    <a href="{{ url_for('history') }}?type_filter=wastage" class="btn btn-outline-info">
                        <i class="fas fa-history me-1"></i>Full Wastage History
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportWastageReport()">
                        <i class="fas fa-download me-1"></i>Export Report
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printWastageReport()">
                        <i class="fas fa-print me-1"></i>Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wastage Modal -->
<div class="modal fade" id="wastageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title">Record Wastage</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" id="wastageItemId" name="item_id">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will remove the item from inventory and record it as wastage.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Item Details</label>
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1" id="wastageItemName"></h6>
                                <small class="text-muted" id="wastageItemDetails"></small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="wastageQuantity" class="form-label">Quantity to Dispose <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="wastageQuantity" name="quantity" min="1" required>
                        <div class="form-text">Available: <span id="wastageMaxQuantity"></span></div>
                    </div>
                    <div class="mb-3">
                        <label for="wastageReason" class="form-label">Reason for Wastage <span class="text-danger">*</span></label>
                        <select class="form-select" id="wastageReason" name="reason" required>
                            <option value="">Select reason...</option>
                            <option value="Expired - normal disposal">Expired - normal disposal</option>
                            <option value="Expired - contaminated">Expired - contaminated</option>
                            <option value="Damaged packaging">Damaged packaging</option>
                            <option value="Contaminated">Contaminated</option>
                            <option value="Recalled by manufacturer">Recalled by manufacturer</option>
                            <option value="Storage conditions compromised">Storage conditions compromised</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3" id="customReasonDiv" style="display: none;">
                        <label for="customReason" class="form-label">Custom Reason</label>
                        <textarea class="form-control" id="customReason" rows="2" placeholder="Please specify the reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Record Wastage
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize DataTables
$(document).ready(function() {
    $('#expiredTable, #wastageTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[0, 'desc']],
        columnDefs: [
            { orderable: false, targets: [-1] }
        ]
    });
});

let currentWastageData = null;

function showWastageModal(itemId, itemName, maxQuantity, itemType, bagName) {
    currentWastageData = {
        id: itemId,
        name: itemName,
        type: itemType,
        maxQuantity: maxQuantity,
        bagName: bagName
    };
    
    // Update modal content
    document.getElementById('wastageItemId').value = itemId;
    document.getElementById('wastageItemName').textContent = itemName;
    document.getElementById('wastageItemDetails').textContent = `${itemType} | From: ${bagName}`;
    document.getElementById('wastageMaxQuantity').textContent = maxQuantity;
    document.getElementById('wastageQuantity').max = maxQuantity;
    document.getElementById('wastageQuantity').value = maxQuantity; // Default to all available
    document.getElementById('wastageReason').value = '';
    document.getElementById('customReasonDiv').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('wastageModal'));
    modal.show();
}

// Handle custom reason selection
document.getElementById('wastageReason').addEventListener('change', function() {
    const customDiv = document.getElementById('customReasonDiv');
    if (this.value === 'Other') {
        customDiv.style.display = 'block';
        document.getElementById('customReason').required = true;
    } else {
        customDiv.style.display = 'none';
        document.getElementById('customReason').required = false;
    }
});

// Form validation
document.querySelector('#wastageModal form').addEventListener('submit', function(e) {
    const quantity = parseInt(document.getElementById('wastageQuantity').value);
    const reason = document.getElementById('wastageReason').value;
    const customReason = document.getElementById('customReason').value;
    
    if (!quantity || quantity <= 0) {
        e.preventDefault();
        alert('Please enter a valid quantity');
        return false;
    }
    
    if (currentWastageData && quantity > currentWastageData.maxQuantity) {
        e.preventDefault();
        alert(`Cannot waste more than ${currentWastageData.maxQuantity} units`);
        return false;
    }
    
    if (!reason) {
        e.preventDefault();
        alert('Please select a reason for wastage');
        return false;
    }
    
    if (reason === 'Other' && !customReason.trim()) {
        e.preventDefault();
        alert('Please specify the custom reason');
        return false;
    }
    
    // Update reason field with custom reason if selected
    if (reason === 'Other' && customReason.trim()) {
        document.getElementById('wastageReason').value = customReason.trim();
    }
    
    // Confirm wastage
    const itemName = currentWastageData ? currentWastageData.name : 'selected item';
    const finalReason = reason === 'Other' ? customReason.trim() : reason;
    
    if (!confirm(`Record wastage of ${quantity} units of ${itemName}?\nReason: ${finalReason}`)) {
        e.preventDefault();
        return false;
    }
});

// Export wastage report
function exportWastageReport() {
    const today = new Date().toISOString().split('T')[0];
    let csvContent = 'Date,Time,Item Name,Type,Quantity,From Bag,Expiry Date,Reason\n';
    
    // Get table data
    const table = document.getElementById('wastageTable');
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const date = cells[0].querySelector('strong').textContent.trim();
            const time = cells[0].querySelector('small').textContent.trim();
            const itemName = cells[1].textContent.trim();
            const type = cells[2].textContent.trim();
            const quantity = cells[3].textContent.trim();
            const fromBag = cells[4].textContent.trim();
            const expiryDate = cells[5].textContent.trim();
            const reason = cells[6].textContent.trim();
            
            csvContent += `"${date}","${time}","${itemName}","${type}","${quantity}","${fromBag}","${expiryDate}","${reason}"\n`;
        });
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'wastage_report_' + today + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print wastage report
function printWastageReport() {
    window.print();
}
</script>
{% endblock %}