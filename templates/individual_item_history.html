{% extends "base.html" %}

{% block title %}{{ item.name }} - Individual Item History{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-box me-2"></i>
                        {{ item.name }} - Individual Item History
                    </h2>
                    <p class="text-muted">History for Item ID: {{ item.id }}</p>
                </div>
                <div>
                    <a href="{{ url_for('item_history', product_id=product.id) }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-list"></i> Product History
                    </a>
                    <a href="{{ url_for('inventory') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Inventory
                    </a>
                </div>
            </div>

            <!-- Individual Item Details Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Item Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <strong>Generic Name:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="text-muted" id="itemGenericName">{{ item.generic_name or 'Not specified' }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editItemField('generic_name', '{{ item.generic_name or '' }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong>Item Name:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="text-white" id="itemName">{{ item.name }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editItemField('name', '{{ item.name }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong>Type:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary" id="itemType">{{ item.type }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editItemField('type', '{{ item.type }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong>Size:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info" id="itemSize">{{ item.size or 'N/A' }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editItemField('size', '{{ item.size or '' }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong>Current Quantity:</strong><br>
                            <span class="badge bg-{% if item.quantity <= 5 %}warning{% else %}primary{% endif %}">{{ item.quantity }}</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Current Storage:</strong><br>
                            <span class="badge bg-success">{{ item.bag.name }}</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Status:</strong><br>
                            {% if item.expiry_status == 'expired' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times-circle"></i> Expired
                                </span>
                            {% elif item.expiry_status == 'expiring' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-clock"></i> Expiring Soon
                                </span>
                            {% else %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> Good
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Additional Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Date Added:</strong><br>
                            <span class="text-info">{{ item.date_added|format_datetime_gmt4 if item.date_added else 'Unknown' }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Expiry Date:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="text-{% if item.expiry_status == 'expired' %}danger{% elif item.expiry_status == 'expiring' %}warning{% else %}success{% endif %}" id="itemExpiry">
                                    {% if item.expiry_date %}
                                        {{ item.expiry_date|format_date_gmt4 }}
                                    {% else %}
                                        <span class="text-muted">No expiry date</span>
                                    {% endif %}
                                </span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editExpiryField('{{ item.expiry_date|format_date_gmt4 if item.expiry_date else '' }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <strong>Brand:</strong><br>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info" id="itemBrand">{{ item.brand or 'Not specified' }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="editItemField('brand', '{{ item.brand or '' }}', {{ item.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Updated:</strong><br>
                            <span class="text-info">{{ item.updated_at|format_datetime_gmt4 if item.updated_at else 'Unknown' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movement History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>
                        Movement History for This Item
                    </h5>
                </div>
                <div class="card-body">
                    {% if movements %}
                        <div class="timeline">
                            {% for movement in movements %}
                            <div class="timeline-item mb-3">
                                <div class="timeline-marker">
                                    {% if movement.movement_type == 'addition' %}
                                        <i class="fas fa-plus text-success"></i>
                                    {% elif movement.movement_type == 'transfer' %}
                                        <i class="fas fa-exchange-alt text-primary"></i>
                                    {% elif movement.movement_type == 'usage' %}
                                        <i class="fas fa-minus text-warning"></i>
                                    {% elif movement.movement_type == 'wastage' %}
                                        <i class="fas fa-trash text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-circle text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <h6 class="mb-1">
                                                        {% if movement.movement_type == 'addition' %}
                                                            <span class="badge bg-success me-2">Added</span>
                                                        {% elif movement.movement_type == 'transfer' %}
                                                            <span class="badge bg-primary me-2">Transferred</span>
                                                        {% elif movement.movement_type == 'usage' %}
                                                            <span class="badge bg-warning me-2">Used</span>
                                                        {% elif movement.movement_type == 'wastage' %}
                                                            <span class="badge bg-danger me-2">Wasted</span>
                                                        {% endif %}
                                                        {{ movement.quantity }} units
                                                        {% if movement.item_size %}
                                                            ({{ movement.item_size }})
                                                        {% endif %}
                                                    </h6>
                                                    <small class="text-muted">
                                                        {{ movement.timestamp.strftime('%m/%d/%Y at %I:%M %p') }}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                {% if movement.from_bag or movement.to_bag %}
                                                <div class="col-md-6">
                                                    <strong>Location:</strong>
                                                    {% if movement.from_bag and movement.to_bag %}
                                                        {{ movement.from_bag }} → {{ movement.to_bag }}
                                                    {% elif movement.to_bag %}
                                                        Added to {{ movement.to_bag }}
                                                    {% elif movement.from_bag %}
                                                        From {{ movement.from_bag }}
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                
                                                {% if movement.patient_name %}
                                                <div class="col-md-6">
                                                    <strong>Patient:</strong> {{ movement.patient_name }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if movement.expiry_date %}
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <strong>Expiry Date:</strong> {{ movement.expiry_date|format_date_gmt4 }}
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if movement.notes %}
                                            <div class="mt-2">
                                                <strong>Notes:</strong>
                                                <p class="mb-0 small">{{ movement.notes }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Movement History Found</h5>
                            <p class="text-muted">No recorded movements for this specific item yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions for This Item -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="showTransferModal('{{ item.id }}', '{{ item.name }}', {{ item.quantity }}, '{{ item.bag.name }}')"
                                title="Transfer this item">
                            <i class="fas fa-exchange-alt me-2"></i>Transfer Item
                        </button>
                        <button type="button" class="btn btn-outline-warning" 
                                onclick="showUsageModal('{{ item.id }}', '{{ item.name }}', {{ item.quantity }})"
                                title="Record usage">
                            <i class="fas fa-minus me-2"></i>Record Usage
                        </button>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="showDeleteModal('{{ item.id }}', '{{ item.name }}', {{ item.quantity }}, '{{ item.bag.name }}')"
                                title="Delete this item">
                            <i class="fas fa-trash me-2"></i>Delete Item
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('delete_item') }}">
                <div class="modal-body">
                    <input type="hidden" id="delete-item-id" name="item_id">
                    <div class="alert alert-danger">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Warning!</strong>
                        This action cannot be undone. The item and all its history will be permanently deleted.
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Item to Delete:</strong></label>
                        <div id="delete-item-details" class="form-control-plaintext bg-light p-2 rounded"></div>
                    </div>
                    <div class="mb-3">
                        <label for="delete-reason" class="form-label"><strong>Reason for Deletion:</strong></label>
                        <select class="form-select" id="delete-reason" name="reason" required>
                            <option value="">Select a reason...</option>
                            <option value="spelling_mistake">Spelling mistake in name</option>
                            <option value="duplicate_entry">Duplicate entry</option>
                            <option value="wrong_information">Wrong item information</option>
                            <option value="data_cleanup">Data cleanup</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="delete-notes" class="form-label">Additional Notes (Optional):</label>
                        <textarea class="form-control" id="delete-notes" name="notes" rows="3" placeholder="Provide additional details about why this item is being deleted..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('transfer') }}">
                <div class="modal-body">
                    <input type="hidden" id="transfer-item-id" name="item_id">
                    <div class="mb-3">
                        <label class="form-label">Item Details</label>
                        <div id="transfer-item-details" class="form-control-plaintext"></div>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-to-bag" class="form-label">Transfer to Storage</label>
                        <select class="form-select" id="transfer-to-bag" name="to_bag_id" required>
                            <option value="">Select destination storage...</option>
                            {% for bag in bags %}
                                <option value="{{ bag.id }}">{{ bag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-quantity" class="form-label">Quantity to Transfer</label>
                        <input type="number" class="form-control" id="transfer-quantity" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="transfer-notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Transfer Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Usage Modal -->
<div class="modal fade" id="usageModal" tabindex="-1" aria-labelledby="usageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Usage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('usage') }}">
                <div class="modal-body">
                    <input type="hidden" id="usage-item-id" name="item_id">
                    <div class="mb-3">
                        <label class="form-label">Item Details</label>
                        <div id="usage-item-details" class="form-control-plaintext"></div>
                    </div>
                    <div class="mb-3">
                        <label for="usage-quantity" class="form-label">Quantity Used</label>
                        <input type="number" class="form-control" id="usage-quantity" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="usage-patient" class="form-label">Patient Name (Optional)</label>
                        <input type="text" class="form-control" id="usage-patient" name="patient_name">
                    </div>
                    <div class="mb-3">
                        <label for="usage-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="usage-notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Record Usage</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_head %}
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: -21px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-content {
    margin-left: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function showTransferModal(itemId, itemName, quantity, bagName) {
    document.getElementById('transfer-item-id').value = itemId;
    document.getElementById('transfer-item-details').textContent = `${itemName} (${quantity} units from ${bagName})`;
    document.getElementById('transfer-quantity').max = quantity;
    document.getElementById('transfer-quantity').value = quantity;
    new bootstrap.Modal(document.getElementById('transferModal')).show();
}

function showUsageModal(itemId, itemName, quantity) {
    document.getElementById('usage-item-id').value = itemId;
    document.getElementById('usage-item-details').textContent = `${itemName} (${quantity} units available)`;
    document.getElementById('usage-quantity').max = quantity;
    document.getElementById('usage-quantity').value = 1;
    new bootstrap.Modal(document.getElementById('usageModal')).show();
}

function showDeleteModal(itemId, itemName, quantity, bagName) {
    document.getElementById('delete-item-id').value = itemId;
    document.getElementById('delete-item-details').textContent = `${itemName} (${quantity} units in ${bagName})`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}