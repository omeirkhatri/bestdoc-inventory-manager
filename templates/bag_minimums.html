{% extends "base.html" %}

{% block title %}Bag Minimums - Medical Inventory{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-briefcase-medical me-2"></i>Bag Minimum Quantities</h2>
                <div>
                    <button id="editModeBtn" class="btn btn-primary me-2" onclick="toggleEditMode()">
                        <i class="fas fa-edit me-1"></i>Edit Mode
                    </button>
                    <button id="saveChangesBtn" class="btn btn-success me-2" onclick="saveAllChanges()" style="display: none;">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                    <button id="cancelEditBtn" class="btn btn-secondary me-2" onclick="cancelEdit()" style="display: none;">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button class="btn btn-outline-success" onclick="exportBagMinimumsReport()">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                </div>
            </div>

            {% if low_stock_bags %}
            <!-- Low Stock Alert -->
            <div class="alert alert-warning mb-4">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Bags Need Restocking</h5>
                <div class="row">
                    {% for bag_info in low_stock_bags %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="fas fa-briefcase me-2"></i>{{ bag_info.bag.name }}
                                </h6>
                                {% for item in bag_info.low_items %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>{{ item.product.name }}</small>
                                    <span class="badge bg-warning text-dark">
                                        {{ item.current }}/{{ item.minimum }} (need {{ item.shortage }})
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Instructions -->
            <div class="alert alert-info mb-4">
                <h6><i class="fas fa-info-circle me-2"></i>Bag Minimum Management</h6>
                <ul class="mb-0">
                    <li><strong>Set Minimums:</strong> Click on any cell to set the minimum quantity for that product in that bag</li>
                    <li><strong>Two-Level System:</strong> Global minimums (for total inventory) + individual bag minimums</li>
                    <li><strong>Monitoring:</strong> Bags below minimum will appear in alerts and dashboard warnings</li>
                    <li><strong>Remove Minimums:</strong> Set to 0 to remove minimum requirement for a product in a specific bag</li>
                </ul>
            </div>

            <!-- Minimums Management Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>Minimum Quantities by Bag
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="bagMinimumsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th>Global Min</th>
                                    {% for bag in bags %}
                                    {% if bag.name != 'Cabinet' %}
                                    <th class="text-center">
                                        <i class="fas fa-briefcase me-1"></i>{{ bag.name }}
                                    </th>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr>
                                    <td><strong>{{ product.name }}</strong></td>
                                    <td><span class="badge bg-secondary">{{ product.type }}</span></td>
                                    <td>
                                        <span class="badge bg-primary">{{ product.minimum_stock }}</span>
                                    </td>
                                    {% for bag in bags %}
                                    {% if bag.name != 'Cabinet' %}
                                    <td class="text-center">
                                        {% set key = bag.id|string + '_' + product.id|string %}
                                        {% set minimum = minimums_dict.get(key) %}
                                        <div class="minimum-cell" 
                                             data-bag-id="{{ bag.id }}" 
                                             data-product-id="{{ product.id }}"
                                             data-bag-name="{{ bag.name }}"
                                             data-product-name="{{ product.name }}"
                                             data-current-value="{{ minimum.minimum_quantity if minimum else 0 }}">
                                            {% if minimum %}
                                                {% set current_qty = minimum.current_quantity() %}
                                                {% if minimum.is_below_minimum() %}
                                                <span class="badge bg-danger cursor-pointer view-mode" onclick="editMinimum(this)">
                                                    {{ minimum.minimum_quantity }} ({{ current_qty }})
                                                </span>
                                                {% else %}
                                                <span class="badge bg-success cursor-pointer view-mode" onclick="editMinimum(this)">
                                                    {{ minimum.minimum_quantity }} ({{ current_qty }})
                                                </span>
                                                {% endif %}
                                            {% else %}
                                            <span class="badge bg-light text-dark cursor-pointer view-mode" onclick="editMinimum(this)">
                                                Not Set
                                            </span>
                                            {% endif %}
                                            <input type="number" class="form-control form-control-sm edit-mode d-none" 
                                                   min="0" max="999" 
                                                   value="{{ minimum.minimum_quantity if minimum else 0 }}"
                                                   onchange="markAsChanged(this)"
                                                   style="width: 80px; text-align: center;">
                                        </div>
                                    </td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Current Stock Summary -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Current Stock Levels by Bag
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for bag in bags %}
                        {% if bag.name != 'Cabinet' %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <h6 class="card-title">{{ bag.name }}</h6>
                                    <small class="text-muted">{{ bag.description }}</small>
                                    <div class="mt-2">
                                        <strong>Total Items: </strong>
                                        <span class="badge bg-info">{{ bag.get_total_items() }}</span>
                                    </div>
                                    <div class="mt-1">
                                        <strong>Minimums Set: </strong>
                                        <span class="badge bg-secondary">{{ bag.minimums|length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Minimum Modal -->
<div class="modal fade" id="editMinimumModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Minimum Quantity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="minimumDescription"></p>
                <div class="mb-3">
                    <label for="minimumQuantity" class="form-label">Minimum Quantity</label>
                    <input type="number" class="form-control" id="minimumQuantity" min="0" placeholder="Enter minimum quantity (0 to remove)">
                    <div class="form-text">Set to 0 to remove minimum requirement for this product in this bag</div>
                </div>
                <div id="currentStockInfo" class="alert alert-info" style="display: none;">
                    <small id="currentStockText"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMinimum()">Save Minimum</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentBagId, currentProductId, currentBagName, currentProductName;

// Edit mode functions - define these first
let isEditMode = false;
let changedCells = new Set();

function toggleEditMode() {
    isEditMode = !isEditMode;
    
    console.log('Toggle edit mode to:', isEditMode);
    console.log('Found view-mode elements:', document.querySelectorAll('.view-mode').length);
    console.log('Found edit-mode elements:', document.querySelectorAll('.edit-mode').length);
    
    if (isEditMode) {
        // Enter edit mode
        document.getElementById('editModeBtn').innerHTML = '<i class="fas fa-eye me-1"></i>View Mode';
        document.getElementById('editModeBtn').className = 'btn btn-secondary me-2';
        document.getElementById('saveChangesBtn').style.display = 'inline-block';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        
        // Show all input fields and hide badges in minimum cells only
        document.querySelectorAll('td.minimum-cell .view-mode').forEach(el => {
            console.log('Hiding view element:', el);
            el.classList.add('d-none');
        });
        document.querySelectorAll('td.minimum-cell .edit-mode').forEach(el => {
            console.log('Showing edit element:', el);
            el.classList.remove('d-none');
        });
        
    } else {
        // Exit edit mode
        document.getElementById('editModeBtn').innerHTML = '<i class="fas fa-edit me-1"></i>Edit Mode';
        document.getElementById('editModeBtn').className = 'btn btn-primary me-2';
        document.getElementById('saveChangesBtn').style.display = 'none';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // Show badges and hide input fields
        document.querySelectorAll('td.minimum-cell .view-mode').forEach(el => {
            el.classList.remove('d-none');
        });
        document.querySelectorAll('td.minimum-cell .edit-mode').forEach(el => {
            el.classList.add('d-none');
        });
        
        // Clear changed cells
        changedCells.clear();
        document.querySelectorAll('.minimum-cell').forEach(cell => {
            cell.classList.remove('table-warning');
        });
    }
}

function markAsChanged(input) {
    const cell = input.closest('.minimum-cell');
    const originalValue = cell.dataset.currentValue;
    const newValue = input.value;
    
    if (originalValue !== newValue) {
        changedCells.add(cell);
        cell.classList.add('table-warning');
    } else {
        changedCells.delete(cell);
        cell.classList.remove('table-warning');
    }
}

function saveAllChanges() {
    if (changedCells.size === 0) {
        showAlert('info', 'No changes to save');
        return;
    }
    
    const changes = [];
    changedCells.forEach(cell => {
        const input = cell.querySelector('.edit-mode');
        changes.push({
            bag_id: parseInt(cell.dataset.bagId),
            product_id: parseInt(cell.dataset.productId),
            minimum_quantity: parseInt(input.value) || 0
        });
    });
    
    fetch('/api/bulk_update_bag_minimums', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({changes: changes})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Updated ${changedCells.size} minimum quantities successfully`);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error || 'Failed to update minimums');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while updating minimums');
    });
}

function cancelEdit() {
    // Reset all input values to original
    changedCells.forEach(cell => {
        const input = cell.querySelector('.edit-mode');
        input.value = cell.dataset.currentValue;
        cell.classList.remove('table-warning');
    });
    
    changedCells.clear();
    toggleEditMode();
}

// Test function first
window.testEditMode = function() {
    console.log('Test function called');
    alert('JavaScript is working!');
};

// Initialize DataTable
$(document).ready(function() {
    console.log('Document ready - initializing');
    
    // Test if toggleEditMode function exists
    if (typeof toggleEditMode === 'function') {
        console.log('toggleEditMode function exists');
    } else {
        console.log('toggleEditMode function NOT found');
    }
    
    // Check if DataTable is available, if not initialize without it
    if (typeof $.fn.DataTable !== 'undefined') {
        $('#bagMinimumsTable').DataTable({
            responsive: true,
            pageLength: 25,
            order: [[0, 'asc']],
            columnDefs: [
                { orderable: false, targets: [2, 3, 4, 5, 6] } // Make minimum columns non-sortable
            ]
        });
    }
    
    // Debug: Log edit mode elements
    console.log('Edit mode elements found:', document.querySelectorAll('.edit-mode').length);
    console.log('View mode elements found:', document.querySelectorAll('.view-mode').length);
    
    // Add click handler manually if needed
    const editBtn = document.getElementById('editModeBtn');
    if (editBtn) {
        console.log('Edit button found, adding click handler');
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Edit button clicked');
            toggleEditMode();
        });
    } else {
        console.log('Edit button NOT found');
    }
});

// Edit minimum function
function editMinimum(element) {
    const cell = element.closest('.minimum-cell');
    currentBagId = cell.dataset.bagId;
    currentProductId = cell.dataset.productId;
    currentBagName = cell.dataset.bagName;
    currentProductName = cell.dataset.productName;
    
    const description = `Set minimum quantity for <strong>${currentProductName}</strong> in <strong>${currentBagName}</strong>`;
    document.getElementById('minimumDescription').innerHTML = description;
    
    // Get current minimum if exists
    const badgeText = element.textContent.trim();
    let currentMinimum = 0;
    if (badgeText !== 'Not Set') {
        const match = badgeText.match(/^(\d+)/);
        if (match) {
            currentMinimum = parseInt(match[1]);
        }
    }
    
    document.getElementById('minimumQuantity').value = currentMinimum;
    
    // Show current stock info
    const stockMatch = badgeText.match(/\((\d+)\)/);
    if (stockMatch) {
        document.getElementById('currentStockText').textContent = `Current stock in this bag: ${stockMatch[1]} items`;
        document.getElementById('currentStockInfo').style.display = 'block';
    } else {
        document.getElementById('currentStockInfo').style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('editMinimumModal'));
    modal.show();
}

// Save minimum function
function saveMinimum() {
    const minimumQuantity = parseInt(document.getElementById('minimumQuantity').value) || 0;
    
    fetch('/api/update_bag_minimum', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            bag_id: currentBagId,
            product_id: currentProductId,
            minimum_quantity: minimumQuantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editMinimumModal'));
            modal.hide();
            
            // Show success message
            showAlert('success', data.message || 'Minimum updated successfully');
            
            // Reload page to refresh data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Failed to update minimum');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while updating minimum');
    });
}

// Show alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of container
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto dismiss after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Export function
function exportBagMinimumsReport() {
    const today = new Date().toISOString().split('T')[0];
    let csvContent = 'Product,Type,Global Minimum,';
    
    // Add bag headers
    const bagHeaders = [];
    document.querySelectorAll('#bagMinimumsTable thead th').forEach((th, index) => {
        if (index > 2) { // Skip Product, Type, Global Min columns
            bagHeaders.push(th.textContent.trim().replace('🧳 ', ''));
        }
    });
    csvContent += bagHeaders.join(',') + '\n';
    
    // Add data rows
    document.querySelectorAll('#bagMinimumsTable tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        const product = cells[0].textContent.trim();
        const type = cells[1].textContent.trim();
        const globalMin = cells[2].textContent.trim();
        
        let rowData = `"${product}","${type}","${globalMin}"`;
        
        // Add minimum values for each bag
        for (let i = 3; i < cells.length; i++) {
            const badgeText = cells[i].querySelector('.badge').textContent.trim();
            let minimum = '0';
            if (badgeText !== 'Not Set') {
                const match = badgeText.match(/^(\d+)/);
                if (match) {
                    minimum = match[1];
                }
            }
            rowData += `,"${minimum}"`;
        }
        
        csvContent += rowData + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bag_minimums_report_' + today + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Add cursor pointer style
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = '.cursor-pointer { cursor: pointer; }';
    document.head.appendChild(style);
});


</script>
{% endblock %}