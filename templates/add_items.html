{% extends "base.html" %}

{% block title %}Add Items - Healthcare Inventory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-plus me-2"></i>
            Add Items
        </h1>
    </div>
</div>

<!-- Add Method Tabs -->
<ul class="nav nav-tabs mb-4" id="addMethodTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
            <i class="fas fa-edit me-2"></i>Manual Entry
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button" role="tab">
            <i class="fas fa-upload me-2"></i>CSV Upload
        </button>
    </li>
</ul>

<div class="tab-content" id="addMethodTabsContent">
    <!-- Manual Entry Tab -->
    <div class="tab-pane fade show active" id="manual" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Manual Entry</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="manualForm">
                    <div class="mb-3">
                        <label for="bag_id" class="form-label">Destination Bag <span class="text-danger">*</span></label>
                        <select class="form-select" id="bag_id" name="bag_id" required>
                            <option value="">Select a bag...</option>
                            {% for bag in bags %}
                            <option value="{{ bag.id }}" {% if bag.name == 'Cabinet' %}selected{% endif %}>{{ bag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="itemRows">
                        <div class="item-row border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Item Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control item-name-input" name="name" required 
                                           autocomplete="off" placeholder="Start typing item name...">
                                    <div class="dropdown-menu item-suggestions" style="display: none;"></div>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Type <span class="text-danger">*</span></label>
                                    <select class="form-select" name="type" required>
                                        <option value="">Select...</option>
                                        {% for item_type in item_types %}
                                        <option value="{{ item_type.name }}">{{ item_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Size</label>
                                    <input type="text" class="form-control" name="size" placeholder="e.g., 22G, 5ml">
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Expiry Date</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" name="expiry_date">
                                        <button type="button" class="btn btn-outline-secondary no-expiry-btn" 
                                                title="No expiry date">
                                            <i class="fas fa-infinity"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-1 mb-2 d-flex align-items-end">
                                    <div class="btn-group-vertical w-100">
                                        <button type="button" class="btn btn-outline-success btn-sm clone-item-btn" 
                                                title="Clone this item for quick entry">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-row" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Box Tracking Section -->
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input box-tracking-checkbox" type="checkbox" name="has_boxes" id="has_boxes">
                                        <label class="form-check-label" for="has_boxes">
                                            <i class="fas fa-box me-1"></i>This item comes in boxes
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pieces per Box (shown when checkbox is checked) -->
                            <div class="row box-config" style="display: none;">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Pieces per Box <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="units_per_box" min="1" placeholder="e.g., 100">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Unit Type</label>
                                    <input type="text" class="form-control" name="packaging_unit" placeholder="e.g., swabs, vials, tablets" value="pieces">
                                </div>
                            </div>
                            
                            <!-- Quantity Section (Dynamic based on box tracking) -->
                            <div class="quantity-section">
                                <!-- Simple quantity (when no box tracking) -->
                                <div class="simple-quantity">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" name="quantity" min="1" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Box/piece quantity (when box tracking enabled) -->
                                <div class="box-piece-quantity" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Number of Boxes</label>
                                            <input type="number" class="form-control boxes-input" name="boxes" min="0" value="0">
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Loose Pieces</label>
                                            <input type="number" class="form-control pieces-input" name="loose_pieces" min="0" value="0">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Total</label>
                                            <div class="form-control-plaintext">
                                                <strong class="total-display">0 pieces</strong>
                                                <small class="text-muted d-block breakdown-display">0 boxes + 0 loose</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                <div class="col-md-5">
                                    <label class="form-label">Minimum Stock <span class="text-muted">(new products only)</span></label>
                                    <input type="number" class="form-control minimum-stock-input" name="minimum_stock" 
                                           min="0" placeholder="Alert when stock below this number">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary" id="addRowBtn">
                            <i class="fas fa-plus me-2"></i>Add Another Item
                        </button>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Add Items
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CSV Upload Tab -->
    <div class="tab-pane fade" id="csv" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">CSV Upload</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>CSV Format Requirements:</h6>
                    <p class="mb-2">Your CSV file should have the following columns:</p>
                    <ul class="mb-2">
                        <li><strong>name</strong> (required) - Item name</li>
                        <li><strong>type</strong> (required) - Item type</li>
                        <li><strong>quantity</strong> (required) - Quantity to add</li>
                        <li><strong>size</strong> (optional) - Item size</li>
                        <li><strong>expiry_date</strong> (optional) - Format: YYYY-MM-DD or MM/DD/YYYY</li>
                        <li><strong>bag</strong> (optional) - Destination bag (defaults to Cabinet)</li>
                    </ul>
                    <small class="text-muted">Example: name,type,quantity,size,expiry_date,bag</small>
                </div>

                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-2"></i>Upload CSV
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Sample CSV Download -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sample CSV Template</h5>
            </div>
            <div class="card-body">
                <p>Download a sample CSV template to get started:</p>
                <button type="button" class="btn btn-outline-info" onclick="downloadSampleCSV()">
                    <i class="fas fa-download me-2"></i>Download Sample CSV
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let itemSuggestions = [];

// Box tracking functionality
function initializeBoxTracking() {
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('box-tracking-checkbox')) {
            toggleBoxTracking(e.target);
        }
    });
    
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('boxes-input') || 
            e.target.classList.contains('pieces-input') || 
            e.target.name === 'units_per_box') {
            updateBoxTotal(e.target);
        }
    });
}

function toggleBoxTracking(checkbox) {
    const itemRow = checkbox.closest('.item-row');
    const boxConfig = itemRow.querySelector('.box-config');
    const simpleQuantity = itemRow.querySelector('.simple-quantity');
    const boxPieceQuantity = itemRow.querySelector('.box-piece-quantity');
    const simpleQuantityInput = itemRow.querySelector('input[name="quantity"]');
    
    if (checkbox.checked) {
        // Show box configuration
        boxConfig.style.display = 'block';
        simpleQuantity.style.display = 'none';
        boxPieceQuantity.style.display = 'block';
        
        // Remove required from simple quantity
        simpleQuantityInput.removeAttribute('required');
        
        // Set default unit type based on common items
        const itemName = itemRow.querySelector('input[name="name"]').value.toLowerCase();
        const unitTypeInput = itemRow.querySelector('input[name="packaging_unit"]');
        
        if (itemName.includes('swab')) {
            unitTypeInput.value = 'swabs';
        } else if (itemName.includes('vial') || itemName.includes('ondansetron')) {
            unitTypeInput.value = 'vials';
        } else if (itemName.includes('tablet') || itemName.includes('paracetamol')) {
            unitTypeInput.value = 'tablets';
        } else if (itemName.includes('pad') || itemName.includes('gauze')) {
            unitTypeInput.value = 'pads';
        }
        
    } else {
        // Hide box configuration
        boxConfig.style.display = 'none';
        simpleQuantity.style.display = 'block';
        boxPieceQuantity.style.display = 'none';
        
        // Add required back to simple quantity
        simpleQuantityInput.setAttribute('required', '');
    }
}

function updateBoxTotal(input) {
    const itemRow = input.closest('.item-row');
    const boxesInput = itemRow.querySelector('.boxes-input');
    const piecesInput = itemRow.querySelector('.pieces-input');
    const unitsPerBoxInput = itemRow.querySelector('input[name="units_per_box"]');
    const totalDisplay = itemRow.querySelector('.total-display');
    const breakdownDisplay = itemRow.querySelector('.breakdown-display');
    const unitTypeInput = itemRow.querySelector('input[name="packaging_unit"]');
    
    if (!boxesInput || !piecesInput || !totalDisplay) return;
    
    const boxes = parseInt(boxesInput.value) || 0;
    const loosePieces = parseInt(piecesInput.value) || 0;
    const unitsPerBox = parseInt(unitsPerBoxInput.value) || 0;
    const unitType = unitTypeInput.value || 'pieces';
    
    const totalPieces = (boxes * unitsPerBox) + loosePieces;
    
    totalDisplay.textContent = `${totalPieces} ${unitType}`;
    breakdownDisplay.textContent = `${boxes} boxes + ${loosePieces} loose`;
    
    // Update label dynamically
    const boxesLabel = itemRow.querySelector('label[for*="boxes"]');
    if (boxesLabel && unitsPerBox > 0) {
        boxesLabel.innerHTML = `<i class="fas fa-box me-2"></i>Number of Boxes (${unitsPerBox} ${unitType} per box)`;
    }
    
    const piecesLabel = itemRow.querySelector('label[for*="pieces"]');
    if (piecesLabel) {
        piecesLabel.innerHTML = `<i class="fas fa-pills me-2"></i>Loose ${unitType}`;
    }
}

// Initialize autocomplete for item names
function initializeAutocomplete() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-name-input')) {
            handleItemNameInput(e.target);
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.item-name-input') && !e.target.closest('.item-suggestions')) {
            hideAllSuggestions();
        }
    });
}

function handleItemNameInput(input) {
    const query = input.value.trim();
    const suggestionsDiv = input.nextElementSibling;
    
    if (query.length < 2) {
        hideSuggestions(suggestionsDiv);
        return;
    }
    
    // Debounced search
    clearTimeout(input.searchTimeout);
    input.searchTimeout = setTimeout(() => {
        searchItems(query, suggestionsDiv, input);
    }, 300);
}

function searchItems(query, suggestionsDiv, input) {
    fetch(`/api/items/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(items => {
            showSuggestions(items, suggestionsDiv, input);
        })
        .catch(error => {
            console.error('Error searching items:', error);
            hideSuggestions(suggestionsDiv);
        });
}

function showSuggestions(items, suggestionsDiv, input) {
    if (items.length === 0) {
        hideSuggestions(suggestionsDiv);
        return;
    }
    
    suggestionsDiv.innerHTML = '';
    items.forEach(item => {
        const suggestionItem = document.createElement('a');
        suggestionItem.className = 'dropdown-item';
        suggestionItem.href = '#';
        suggestionItem.innerHTML = `
            <div>
                <strong>${item.name}</strong>
                <br><small class="text-muted">${item.type}${item.size ? ' - ' + item.size : ''}</small>
            </div>
        `;
        
        suggestionItem.addEventListener('click', function(e) {
            e.preventDefault();
            selectItem(item, input);
            hideSuggestions(suggestionsDiv);
        });
        
        suggestionsDiv.appendChild(suggestionItem);
    });
    
    suggestionsDiv.style.display = 'block';
    suggestionsDiv.style.position = 'absolute';
    suggestionsDiv.style.zIndex = '1000';
    suggestionsDiv.style.width = input.offsetWidth + 'px';
}

function selectItem(item, input) {
    const row = input.closest('.item-row');
    
    // Fill in the item details
    input.value = item.name;
    
    const typeSelect = row.querySelector('select[name="type"]');
    if (typeSelect && item.type) {
        typeSelect.value = item.type;
    }
    
    const sizeInput = row.querySelector('input[name="size"]');
    if (sizeInput && item.size) {
        sizeInput.value = item.size;
    }
    
    // Focus on quantity field
    const quantityInput = row.querySelector('input[name="quantity"]');
    if (quantityInput) {
        quantityInput.focus();
    }
}

function hideSuggestions(suggestionsDiv) {
    suggestionsDiv.style.display = 'none';
}

function hideAllSuggestions() {
    document.querySelectorAll('.item-suggestions').forEach(div => {
        hideSuggestions(div);
    });
}

// Add new row functionality
document.getElementById('addRowBtn').addEventListener('click', function() {
    addNewRow();
});

function addNewRow(templateRow = null) {
    const itemRows = document.getElementById('itemRows');
    const sourceRow = templateRow || itemRows.querySelector('.item-row');
    const newRow = sourceRow.cloneNode(true);
    
    // Clear all input values unless it's a clone
    if (!templateRow) {
        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
    } else {
        // If cloning, clear only quantity and expiry date
        const quantityInput = newRow.querySelector('input[name="quantity"]');
        const expiryInput = newRow.querySelector('input[name="expiry_date"]');
        if (quantityInput) quantityInput.value = '';
        if (expiryInput) expiryInput.value = '';
    }
    
    // Show remove button
    newRow.querySelector('.remove-row').style.display = 'block';
    
    // Hide suggestions for the new row
    const suggestionsDiv = newRow.querySelector('.item-suggestions');
    if (suggestionsDiv) {
        hideSuggestions(suggestionsDiv);
    }
    
    itemRows.appendChild(newRow);
    updateRemoveButtons();
    
    // Focus on the appropriate field
    if (templateRow) {
        const quantityInput = newRow.querySelector('input[name="quantity"]');
        if (quantityInput) quantityInput.focus();
    } else {
        const nameInput = newRow.querySelector('input[name="name"]');
        if (nameInput) nameInput.focus();
    }
}

// Clone item functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.clone-item-btn')) {
        const row = e.target.closest('.item-row');
        const nameInput = row.querySelector('input[name="name"]');
        const typeSelect = row.querySelector('select[name="type"]');
        
        if (nameInput.value.trim() && typeSelect.value) {
            addNewRow(row);
        } else {
            alert('Please fill in the item name and type before cloning');
        }
    }
});

// No expiry date functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.no-expiry-btn')) {
        const button = e.target.closest('.no-expiry-btn');
        const expiryInput = button.parentElement.querySelector('input[name="expiry_date"]');
        
        if (expiryInput.disabled) {
            // Re-enable expiry date
            expiryInput.disabled = false;
            expiryInput.value = '';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
            button.title = 'No expiry date';
        } else {
            // Disable expiry date
            expiryInput.disabled = true;
            expiryInput.value = '';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            button.title = 'Expiry date disabled';
        }
    }
});

// Remove row functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-row')) {
        e.target.closest('.item-row').remove();
        updateRemoveButtons();
    }
});

function updateRemoveButtons() {
    const rows = document.querySelectorAll('.item-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('.remove-row');
        if (rows.length > 1) {
            removeBtn.style.display = 'block';
        } else {
            removeBtn.style.display = 'none';
        }
    });
}

// Download sample CSV
function downloadSampleCSV() {
    const csvContent = 'name,type,quantity,size,expiry_date,bag\n' +
                      'Syringe 10ml,Consumables,50,10ml,2025-12-31,Cabinet\n' +
                      'Needle 22G,Consumables,100,22G,2026-06-15,Cabinet\n' +
                      'Saline Solution,IV Vials,25,500ml,2025-08-20,Cabinet';
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory_sample.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Form validation
document.getElementById('manualForm').addEventListener('submit', function(e) {
    const bagSelect = document.getElementById('bag_id');
    if (!bagSelect.value) {
        e.preventDefault();
        alert('Please select a destination bag');
        bagSelect.focus();
        return false;
    }
    
    let hasValidItem = false;
    const itemRows = document.querySelectorAll('.item-row');
    
    itemRows.forEach(row => {
        const name = row.querySelector('input[name="name"]').value.trim();
        const type = row.querySelector('select[name="type"]').value.trim();
        const hasBoxes = row.querySelector('input[name="has_boxes"]').checked;
        
        let hasQuantity = false;
        if (hasBoxes) {
            const boxes = row.querySelector('input[name="boxes"]').value.trim();
            const pieces = row.querySelector('input[name="loose_pieces"]').value.trim();
            const unitsPerBox = row.querySelector('input[name="units_per_box"]').value.trim();
            hasQuantity = unitsPerBox && (boxes || pieces);
        } else {
            const quantity = row.querySelector('input[name="quantity"]').value.trim();
            hasQuantity = quantity;
        }
        
        if (name && type && hasQuantity) {
            hasValidItem = true;
        }
    });
    
    if (!hasValidItem) {
        e.preventDefault();
        alert('Please fill in at least one complete item (name, type, and quantity)');
        return false;
    }
});

// Initialize autocomplete when page loads
initializeAutocomplete();
</script>
{% endblock %}
