{% extends "base.html" %}

{% block title %}Add Items - Healthcare Inventory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-plus me-2"></i>
            Add Items
        </h1>
    </div>
</div>

<!-- Add Method Tabs -->
<ul class="nav nav-tabs mb-4" id="addMethodTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
            <i class="fas fa-edit me-2"></i>Manual Entry
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button" role="tab">
            <i class="fas fa-upload me-2"></i>CSV Upload
        </button>
    </li>
</ul>

<div class="tab-content" id="addMethodTabsContent">
    <!-- Manual Entry Tab -->
    <div class="tab-pane fade show active" id="manual" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Manual Entry</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="manualForm">
                    <div class="mb-3">
                        <label for="bag_id" class="form-label">Destination Bag <span class="text-danger">*</span></label>
                        <select class="form-select" id="bag_id" name="bag_id" required>
                            <option value="">Select a bag...</option>
                            {% for bag in bags %}
                            <option value="{{ bag.id }}" {% if bag.name == 'Cabinet' %}selected{% endif %}>{{ bag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="itemRows">
                        <div class="item-row border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Item Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control item-name-input" name="name" required 
                                           autocomplete="off" placeholder="Start typing item name...">
                                    <div class="dropdown-menu item-suggestions" style="display: none;"></div>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Type <span class="text-danger">*</span></label>
                                    <select class="form-select" name="type" required>
                                        <option value="">Select...</option>
                                        {% for item_type in item_types %}
                                        <option value="{{ item_type.name }}">{{ item_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control item-brand-input" name="brand" placeholder="Brand name (optional)">
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Size</label>
                                    <input type="text" class="form-control" name="size" placeholder="e.g., 22G, 5ml">
                                </div>
                                <div class="col-md-2 mb-2">
                                    <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="quantity" min="1" required>
                                </div>
                                <div class="col-md-1 mb-2 d-flex align-items-end">
                                    <div class="btn-group-vertical w-100">
                                        <button type="button" class="btn btn-outline-success btn-sm clone-item-btn" 
                                                title="Clone this item for quick entry">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-row" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Expiry Date</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" name="expiry_date">
                                        <button type="button" class="btn btn-outline-secondary no-expiry-btn" 
                                                title="No expiry date">
                                            <i class="fas fa-infinity"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Minimum Stock <span class="text-muted">(new products only)</span></label>
                                    <input type="number" class="form-control minimum-stock-input" name="minimum_stock" 
                                           min="0" placeholder="Alert when stock below this number">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary" id="addRowBtn">
                            <i class="fas fa-plus me-2"></i>Add Another Item
                        </button>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Add Items
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CSV Upload Tab -->
    <div class="tab-pane fade" id="csv" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">CSV Upload</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>CSV Format Requirements:</h6>
                    <p class="mb-2">Your CSV file should have the following columns:</p>
                    <ul class="mb-2">
                        <li><strong>name</strong> (required) - Item name</li>
                        <li><strong>type</strong> (required) - Item type</li>
                        <li><strong>quantity</strong> (required) - Quantity to add</li>
                        <li><strong>size</strong> (optional) - Item size</li>
                        <li><strong>expiry_date</strong> (optional) - Format: YYYY-MM-DD or MM/DD/YYYY</li>
                        <li><strong>bag</strong> (optional) - Destination bag (defaults to Cabinet)</li>
                    </ul>
                    <small class="text-muted">Example: name,type,quantity,size,expiry_date,bag</small>
                </div>

                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-2"></i>Upload CSV
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Sample CSV Download -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sample CSV Template</h5>
            </div>
            <div class="card-body">
                <p>Download a sample CSV template to get started:</p>
                <button type="button" class="btn btn-outline-info" onclick="downloadSampleCSV()">
                    <i class="fas fa-download me-2"></i>Download Sample CSV
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let itemSuggestions = {{ autocomplete_items|tojson }};

// Initialize autocomplete for item names
function initializeAutocomplete() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-name-input')) {
            handleItemNameInput(e.target);
        }
    });
    
    // Only hide suggestions when clicking FAR outside - give more tolerance
    document.addEventListener('click', function(e) {
        // Don't hide if clicking on input, suggestions, or any form element
        if (e.target.closest('.item-name-input') || 
            e.target.closest('.item-suggestions') || 
            e.target.closest('.item-row') ||
            e.target.closest('input') ||
            e.target.closest('select')) {
            return;
        }
        // Only hide if clicking completely outside the form area
        setTimeout(() => {
            hideAllSuggestions();
        }, 500); // 500ms delay before hiding
    });
    
    // Handle focus events to show suggestions again if there's content
    document.addEventListener('focus', function(e) {
        if (e.target.classList.contains('item-name-input')) {
            const query = e.target.value.trim();
            if (query.length >= 2) {
                handleItemNameInput(e.target);
            }
        }
    });
    
    // Handle keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('item-name-input')) {
            const suggestionsDiv = e.target.nextElementSibling;
            const suggestions = suggestionsDiv.querySelectorAll('.dropdown-item');
            
            if (suggestions.length > 0 && suggestionsDiv.style.display === 'block') {
                let activeIndex = -1;
                suggestions.forEach((item, index) => {
                    if (item.classList.contains('active')) {
                        activeIndex = index;
                    }
                });
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = (activeIndex + 1) % suggestions.length;
                    updateActiveSelection(suggestions, activeIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = activeIndex <= 0 ? suggestions.length - 1 : activeIndex - 1;
                    updateActiveSelection(suggestions, activeIndex);
                } else if (e.key === 'Enter' && activeIndex >= 0) {
                    e.preventDefault();
                    suggestions[activeIndex].click();
                } else if (e.key === 'Escape') {
                    hideSuggestions(suggestionsDiv);
                }
            }
        }
    });
    
    // Initialize minimum stock field visibility for existing rows
    document.querySelectorAll('.item-row').forEach(row => {
        toggleMinimumStockField(row, true); // Show by default for new items
    });
}

function handleItemNameInput(input) {
    const query = input.value.trim();
    const suggestionsDiv = input.nextElementSibling;
    const row = input.closest('.item-row');
    
    // Check if product exists for minimum stock field visibility
    clearTimeout(input.checkTimeout);
    input.checkTimeout = setTimeout(() => {
        checkIfProductExists(query, row);
    }, 500);
    
    if (query.length < 2) {
        // Don't hide suggestions immediately - let them stay visible
        return;
    }
    
    // Immediate search without debounce to keep suggestions visible
    clearTimeout(input.searchTimeout);
    input.searchTimeout = setTimeout(() => {
        searchItems(query, suggestionsDiv, input);
    }, 100);
}

function searchItems(query, suggestionsDiv, input) {
    // Filter items locally using the data passed from server
    const filteredItems = itemSuggestions.filter(item => 
        item.name.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 10); // Limit to 10 results
    
    console.log('Search results:', filteredItems);
    showSuggestions(filteredItems, suggestionsDiv, input);
}

function showSuggestions(items, suggestionsDiv, input) {
    // NEVER auto-hide suggestions - only hide when user explicitly dismisses
    if (items.length === 0) {
        // Show a "no results" message instead of hiding
        suggestionsDiv.innerHTML = '<div class="dropdown-item text-muted"><em>No matching items found</em></div>';
        suggestionsDiv.style.display = 'block';
        suggestionsDiv.style.position = 'absolute';
        suggestionsDiv.style.zIndex = '9999';
        suggestionsDiv.style.width = input.offsetWidth + 'px';
        suggestionsDiv.style.maxHeight = '300px';
        suggestionsDiv.style.overflowY = 'auto';
        suggestionsDiv.style.border = '1px solid #ccc';
        suggestionsDiv.style.backgroundColor = 'var(--bs-body-bg)';
        suggestionsDiv.style.borderRadius = '0.375rem';
        suggestionsDiv.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
        return;
    }
    
    suggestionsDiv.innerHTML = '';
    items.forEach(item => {
        const suggestionItem = document.createElement('a');
        suggestionItem.className = 'dropdown-item';
        suggestionItem.href = '#';
        suggestionItem.innerHTML = `
            <div>
                <strong>${item.name}</strong>
                ${item.brand ? '<span class="badge bg-secondary ms-2">' + item.brand + '</span>' : ''}
                <br><small class="text-muted">${item.type}${item.size ? ' - ' + item.size : ''}${item.source === 'current' ? ' (In Stock)' : ' (From History)'}</small>
            </div>
        `;
        
        suggestionItem.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            selectItem(item, input);
            // MANUALLY hide suggestions only when user selects an item
            suggestionsDiv.style.display = 'none';
        });
        
        suggestionItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        // Prevent suggestions from hiding when hovering over them
        suggestionItem.addEventListener('mouseenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        suggestionsDiv.appendChild(suggestionItem);
    });
    
    suggestionsDiv.style.display = 'block';
    suggestionsDiv.style.position = 'absolute';
    suggestionsDiv.style.zIndex = '9999';
    suggestionsDiv.style.width = input.offsetWidth + 'px';
    suggestionsDiv.style.maxHeight = '300px';
    suggestionsDiv.style.overflowY = 'auto';
    suggestionsDiv.style.border = '1px solid #ccc';
    suggestionsDiv.style.backgroundColor = 'var(--bs-body-bg)';
    suggestionsDiv.style.borderRadius = '0.375rem';
    suggestionsDiv.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)';
}

function selectItem(item, input) {
    const row = input.closest('.item-row');
    
    // Fill in the item details
    input.value = item.name;
    
    // Auto-fill type
    const typeSelect = row.querySelector('select[name="type"]');
    if (typeSelect && item.type) {
        typeSelect.value = item.type;
    }
    
    // Auto-fill brand
    const brandInput = row.querySelector('input[name="brand"]');
    if (brandInput && item.brand) {
        brandInput.value = item.brand;
    }
    
    // Auto-fill size
    const sizeInput = row.querySelector('input[name="size"]');
    if (sizeInput && item.size) {
        sizeInput.value = item.size;
    }
    
    // Auto-fill expiry date if available (but leave it editable for new batches)
    const expiryInput = row.querySelector('input[name="expiry_date"]');
    if (expiryInput && item.latest_expiry && item.source === 'current') {
        // Don't auto-fill if it's an old date
        const latestExpiry = new Date(item.latest_expiry);
        const today = new Date();
        if (latestExpiry > today) {
            expiryInput.value = item.latest_expiry;
        }
    }
    
    // Set focus to quantity field for quick entry
    const quantityInput = row.querySelector('input[name="quantity"]');
    if (quantityInput) {
        setTimeout(() => quantityInput.focus(), 100);
    }
    
    // Hide minimum stock field since this is an existing item
    toggleMinimumStockField(row, false);
}

function hideSuggestions(suggestionsDiv) {
    console.log('hideSuggestions called - BLOCKING THIS ACTION');
    // NEVER hide suggestions automatically - this is the source of the problem
    // suggestionsDiv.style.display = 'none';
}

function hideAllSuggestions() {
    document.querySelectorAll('.item-suggestions').forEach(div => {
        hideSuggestions(div);
    });
}

function updateActiveSelection(suggestions, activeIndex) {
    suggestions.forEach((item, index) => {
        if (index === activeIndex) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('active');
        }
    });
}

function toggleMinimumStockField(row, show) {
    const minimumStockDiv = row.querySelector('.col-md-5');
    if (minimumStockDiv) {
        minimumStockDiv.style.display = show ? 'block' : 'none';
        const minimumStockInput = row.querySelector('input[name="minimum_stock"]');
        if (minimumStockInput && !show) {
            minimumStockInput.value = '';
        }
    }
}

function checkIfProductExists(itemName, row) {
    if (!itemName || itemName.length < 2) {
        toggleMinimumStockField(row, true);
        return;
    }
    
    // Check locally instead of making API calls that can fail
    const exists = itemSuggestions.some(item => 
        item.name.toLowerCase() === itemName.toLowerCase()
    );
    toggleMinimumStockField(row, !exists);
}

// Add new row functionality
document.getElementById('addRowBtn').addEventListener('click', function() {
    addNewRow();
});

function addNewRow(templateRow = null) {
    const itemRows = document.getElementById('itemRows');
    const sourceRow = templateRow || itemRows.querySelector('.item-row');
    const newRow = sourceRow.cloneNode(true);
    
    // Clear all input values unless it's a clone
    if (!templateRow) {
        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
    } else {
        // If cloning (duplicating), keep all fields except quantity
        // This allows users to quickly add multiple items with same details
        const quantityInput = newRow.querySelector('input[name="quantity"]');
        if (quantityInput) quantityInput.value = '';
        
        // Clear minimum stock field for duplicated rows since it's only for new products
        const minimumStockInput = newRow.querySelector('input[name="minimum_stock"]');
        if (minimumStockInput) minimumStockInput.value = '';
        
        // Keep all other fields: name, type, brand, size, expiry_date
        // No need to clear them as they should be duplicated
    }
    
    // Show remove button
    newRow.querySelector('.remove-row').style.display = 'block';
    
    // Hide suggestions for the new row
    const suggestionsDiv = newRow.querySelector('.item-suggestions');
    if (suggestionsDiv) {
        hideSuggestions(suggestionsDiv);
    }
    
    // Initialize minimum stock field visibility for new row
    if (!templateRow) {
        toggleMinimumStockField(newRow, true); // Show by default for new items
    }
    
    itemRows.appendChild(newRow);
    updateRemoveButtons();
    
    // Focus on the appropriate field
    if (templateRow) {
        const quantityInput = newRow.querySelector('input[name="quantity"]');
        if (quantityInput) quantityInput.focus();
    } else {
        const nameInput = newRow.querySelector('input[name="name"]');
        if (nameInput) nameInput.focus();
    }
}

// Clone functionality is handled by main.js ProductManager - no duplicate handlers needed

// No expiry date functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.no-expiry-btn')) {
        const button = e.target.closest('.no-expiry-btn');
        const expiryInput = button.parentElement.querySelector('input[name="expiry_date"]');
        
        if (expiryInput.disabled) {
            // Re-enable expiry date
            expiryInput.disabled = false;
            expiryInput.value = '';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
            button.title = 'No expiry date';
        } else {
            // Disable expiry date
            expiryInput.disabled = true;
            expiryInput.value = '';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            button.title = 'Expiry date disabled';
        }
    }
});

// Remove row functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-row')) {
        e.target.closest('.item-row').remove();
        updateRemoveButtons();
    }
});

function updateRemoveButtons() {
    const rows = document.querySelectorAll('.item-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('.remove-row');
        if (rows.length > 1) {
            removeBtn.style.display = 'block';
        } else {
            removeBtn.style.display = 'none';
        }
    });
}

// Download sample CSV
function downloadSampleCSV() {
    const csvContent = 'name,type,quantity,size,expiry_date,bag\n' +
                      'Syringe 10ml,Consumables,50,10ml,2025-12-31,Cabinet\n' +
                      'Needle 22G,Consumables,100,22G,2026-06-15,Cabinet\n' +
                      'Saline Solution,IV Vials,25,500ml,2025-08-20,Cabinet';
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory_sample.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Form validation
document.getElementById('manualForm').addEventListener('submit', function(e) {
    const bagSelect = document.getElementById('bag_id');
    if (!bagSelect.value) {
        e.preventDefault();
        alert('Please select a destination bag');
        bagSelect.focus();
        return false;
    }
    
    let hasValidItem = false;
    const itemRows = document.querySelectorAll('.item-row');
    
    itemRows.forEach(row => {
        const name = row.querySelector('input[name="name"]').value.trim();
        const type = row.querySelector('select[name="type"]').value.trim();
        const quantity = row.querySelector('input[name="quantity"]').value.trim();
        
        if (name && type && quantity) {
            hasValidItem = true;
        }
    });
    
    if (!hasValidItem) {
        e.preventDefault();
        alert('Please fill in at least one complete item (name, type, and quantity)');
        return false;
    }
});

// Initialize autocomplete when page loads
initializeAutocomplete();

// OVERRIDE ANY CONFLICTING AUTOCOMPLETE SYSTEMS
// Disable any existing autocomplete handlers that might be interfering
document.addEventListener('DOMContentLoaded', function() {
    // Remove any existing event listeners that might be hiding suggestions
    const itemInputs = document.querySelectorAll('.item-name-input');
    itemInputs.forEach(input => {
        // Clone element to remove all existing event listeners
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
    });
    
    // Re-initialize our autocomplete after clearing conflicting handlers
    setTimeout(() => {
        initializeAutocomplete();
    }, 100);
});
</script>
{% endblock %}
