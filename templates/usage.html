{% extends "base.html" %}

{% block title %}Record Usage - Healthcare Inventory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-minus me-2"></i>
            Record Usage
        </h1>
    </div>
</div>

<div class="row">
    {% for bag_name, items in bag_items.items() %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-briefcase me-2"></i>
                    {{ bag_name }}
                </h5>
            </div>
            <div class="card-body">
                {% if items %}
                <div class="list-group">
                    {% for item in items %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.name }}</h6>
                                <p class="mb-1">
                                    <span class="badge bg-secondary me-2">{{ item.type }}</span>
                                    {% if item.size %}
                                    <span class="badge bg-info me-2">{{ item.size }}</span>
                                    {% endif %}
                                    <span class="badge bg-{% if item.quantity <= 5 %}warning{% else %}primary{% endif %}">
                                        {{ item.quantity }} units
                                    </span>
                                </p>
                                <small class="text-muted">
                                    {% if item.expiry_date %}
                                        Expires: {{ item.expiry_date|format_date_gmt4 }}
                                        {% if item.expiry_status == 'expired' %}
                                            <span class="badge bg-danger ms-1">Expired</span>
                                        {% elif item.expiry_status == 'expiring' %}
                                            <span class="badge bg-warning ms-1">Expiring Soon</span>
                                        {% endif %}
                                    {% else %}
                                        No expiry date
                                    {% endif %}
                                </small>
                            </div>
                            <button type="button" class="btn btn-warning btn-sm" 
                                    onclick="showUsageModal('{{ item.id }}', '{{ item.name }}', '{{ item.type }}', '{{ item.size or '' }}', {{ item.quantity }}, '{{ bag_name }}')">
                                <i class="fas fa-minus"></i> Use
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-box-open fa-2x text-muted mb-3"></i>
                    <h6 class="text-muted">No items in {{ bag_name }}</h6>
                    <p class="text-muted">
                        <a href="{{ url_for('transfer') }}">Transfer items</a> from Cabinet to this bag.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not bag_items %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Medical Bags Found</h4>
                <p class="text-muted mb-4">You need to create medical bags before recording usage.</p>
                <a href="{{ url_for('bags') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Bags
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Usage Instructions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Usage Recording</h6>
            <ul class="mb-0">
                <li><strong>Medical Bags Only:</strong> Usage can only be recorded from medical bags, not from the Cabinet</li>
                <li><strong>Quantity Tracking:</strong> Enter the exact number of units used</li>
                <li><strong>Notes:</strong> Add patient information, procedure details, or other relevant notes</li>
                <li><strong>Automatic Logging:</strong> All usage is automatically logged in the movement history</li>
                <li><strong>Stock Updates:</strong> Item quantities are automatically reduced when usage is recorded</li>
            </ul>
        </div>
    </div>
</div>

<!-- Usage Modal -->
<div class="modal fade" id="usageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Usage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="usageForm">
                <div class="modal-body">
                    <input type="hidden" id="item_id" name="item_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Item Details</label>
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1" id="itemName"></h6>
                                <small class="text-muted" id="itemDetails"></small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity Used <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                        <div class="form-text">Available: <span id="maxQuantity">0</span> units</div>
                    </div>

                    <div class="mb-3">
                        <label for="patient_name" class="form-label">Patient Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="patient_name" name="patient_name" required 
                               placeholder="Enter patient name or ID">
                        <div class="form-text">Required for usage tracking and compliance</div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Procedure details, treatment notes, etc."></textarea>
                        <div class="form-text">Optional: Add details about the usage</div>
                    </div>

                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Important:</strong> This action will reduce the item quantity and cannot be undone. 
                            Make sure the quantity is correct before submitting.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-minus me-2"></i>Record Usage
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentItemData = null;

function showUsageModal(itemId, itemName, itemType, itemSize, maxQuantity, bagName) {
    currentItemData = {
        id: itemId,
        name: itemName,
        type: itemType,
        size: itemSize,
        maxQuantity: maxQuantity,
        bagName: bagName
    };
    
    // Update modal content
    document.getElementById('item_id').value = itemId;
    document.getElementById('itemName').textContent = itemName;
    
    let details = `${itemType}`;
    if (itemSize) {
        details += ` - ${itemSize}`;
    }
    details += ` | From: ${bagName}`;
    document.getElementById('itemDetails').textContent = details;
    
    document.getElementById('maxQuantity').textContent = maxQuantity;
    document.getElementById('quantity').max = maxQuantity;
    document.getElementById('quantity').value = '1'; // Default to 1
    document.getElementById('notes').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('usageModal'));
    modal.show();
    
    // Focus on quantity field
    setTimeout(() => {
        document.getElementById('quantity').focus();
        document.getElementById('quantity').select();
    }, 500);
}

// Form validation
document.getElementById('usageForm').addEventListener('submit', function(e) {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    if (!quantity || quantity <= 0) {
        e.preventDefault();
        alert('Please enter a valid quantity');
        document.getElementById('quantity').focus();
        return false;
    }
    
    if (currentItemData && quantity > currentItemData.maxQuantity) {
        e.preventDefault();
        alert(`Cannot use more than ${currentItemData.maxQuantity} units`);
        document.getElementById('quantity').focus();
        return false;
    }
    
    // Confirm usage
    const itemName = currentItemData ? currentItemData.name : 'selected item';
    const bagName = currentItemData ? currentItemData.bagName : 'bag';
    
    if (!confirm(`Record usage of ${quantity} units of ${itemName} from ${bagName}?`)) {
        e.preventDefault();
        return false;
    }
});

// Real-time quantity validation
document.getElementById('quantity').addEventListener('input', function() {
    const quantity = parseInt(this.value);
    const maxQty = currentItemData ? currentItemData.maxQuantity : 0;
    
    if (quantity > maxQty) {
        this.setCustomValidity(`Maximum available: ${maxQty}`);
        this.reportValidity();
    } else if (quantity <= 0) {
        this.setCustomValidity('Quantity must be greater than 0');
        this.reportValidity();
    } else {
        this.setCustomValidity('');
    }
});

// Quick quantity buttons
document.getElementById('usageModal').addEventListener('shown.bs.modal', function() {
    const modalBody = this.querySelector('.modal-body');
    const quantityInput = document.getElementById('quantity');
    
    // Create quick quantity buttons if not already exist
    if (!modalBody.querySelector('.quick-quantity-buttons')) {
        const quickButtonsDiv = document.createElement('div');
        quickButtonsDiv.className = 'quick-quantity-buttons mb-3';
        quickButtonsDiv.innerHTML = `
            <label class="form-label">Quick Select:</label>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="setQuantity(1)">1</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuantity(2)">2</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuantity(5)">5</button>
                <button type="button" class="btn btn-outline-secondary" onclick="setQuantity(10)">10</button>
            </div>
        `;
        
        // Insert after quantity input
        quantityInput.parentNode.insertBefore(quickButtonsDiv, quantityInput.nextSibling);
    }
});

function setQuantity(qty) {
    const maxQty = currentItemData ? currentItemData.maxQuantity : 0;
    const actualQty = Math.min(qty, maxQty);
    document.getElementById('quantity').value = actualQty;
    
    // Trigger validation
    document.getElementById('quantity').dispatchEvent(new Event('input'));
}

// Auto-focus and select quantity when modal opens
document.getElementById('usageModal').addEventListener('shown.bs.modal', function() {
    setTimeout(() => {
        const quantityInput = document.getElementById('quantity');
        quantityInput.focus();
        quantityInput.select();
    }, 100);
});
</script>
{% endblock %}
